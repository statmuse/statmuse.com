---
import MoneyBaseLayout from '@layouts/money-base.astro'
import Image from '@components/image.astro'
import TradingviewTicker from '@components/tradingview-ticker.astro'
import AnswerShare from '@components/answer-share.astro'
import Explore from '@components/explore.astro'
import type { Metadata } from '@lib/meta'
import { getUrlForEntity, type AssetProfile } from '@statmuse/core/kanedama'
import { imageForgeUrl } from '@statmuse/core/path'
import { cdnBaseUrl } from '@statmuse/core/gamera'
import type { ComponentProps } from 'astro/types'
import type Nav from '@components/nav.astro'
import type { NavLink } from 'src/types'

interface Props {
  profile: AssetProfile
  meta?: Metadata
  query?: string
  page: 'overview' | 'stats' | 'financials' | 'news'
}

const { profile, meta, query, page } = Astro.props

const assetPath = getUrlForEntity({
  type: 'assetProfile',
  id: profile.asset.symbol,
  display: profile.asset.officialName,
})
const [image] = profile.images
const bustImageUrl = image ? image.imageUrl : undefined // default image fallback?
const bustImageAlt = profile.asset.canonicalName

const colors = image
  ? image.colors[0]
  : { foreground: '#fff', background: '#00c1d8' }

const path = Astro.url.pathname
const canonical = { url: Astro.url.pathname + Astro.url.search }

const title = `${
  profile.asset.canonicalName || profile.asset.officialName
} Overview`

const facebook = {
  imageUrl:
    bustImageUrl &&
    imageForgeUrl({
      url: `${cdnBaseUrl}/${bustImageUrl}`,
      bgColor: colors?.background,
      type: 'facebook',
    }),
}
const twitter = {
  imageUrl:
    bustImageUrl &&
    imageForgeUrl({
      url: `${cdnBaseUrl}/${bustImageUrl}`,
      bgColor: colors?.background,
      type: 'twitter',
    }),
}

const links: NavLink[] = [
  { text: 'Overview', href: assetPath, param: 'overview' },
  { text: 'Stats', href: `${assetPath}/stats`, param: 'stats' },
  { text: 'Financials', href: `${assetPath}/financials`, param: 'financials' },
  { text: 'News', href: `${assetPath}/news`, param: 'news' },
]
const navProps: ComponentProps<typeof Nav> = {
  teamColors: true,
  links: links,
  selected: page,
  href: (p) => `${assetPath}/${p}`,
}
---

<MoneyBaseLayout
  tradingview
  {colors}
  meta={{ title, canonical, facebook, twitter, ...(meta || {}) }}
  analytics={{
    query,
    is_search: true,
    page_domain: 'finance',
    page_type: 'asset',
  }}
  {query}
  hero={{
    content: profile.asset.canonicalName,
    imageUrl: bustImageUrl,
    imageAlt: bustImageAlt,
  }}
  {navProps}
>
  <div slot="hero">
    <div class="mt-6" style="height: 94px; overflow: hidden;">
      <TradingviewTicker {profile} />
    </div>
  </div>
  <slot />
  <Explore league="money" />
</MoneyBaseLayout>
