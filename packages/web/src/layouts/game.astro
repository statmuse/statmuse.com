---
import Layout from '@layouts/main.astro'
import Header from '@components/header.astro'
import Container from '@components/container.astro'
import Explore from '@components/explore.astro'
import {
  GameraBoxScore,
  tokensToHtml,
  tokensToText,
} from '@statmuse/core/gamera'
import type { Metadata } from '@lib/meta'
import Hero from '@components/hero.astro'
import { imageForgeUrl } from '@lib/path'
import type { AnalyticsPageviewProperties } from '@lib/analytics'

interface Props {
  data: GameraBoxScore
  meta?: Metadata
}

const { data } = Astro.props
const { league: preferredDomain, game } = Astro.params
if (!game || !preferredDomain) {
  return new Response(null, { status: 404, statusText: 'Not found' })
}

// const domain = league.toUpperCase() as GameraDomain
// const path = Astro.url.pathname
// const canonical = Astro.url.pathname + Astro.url.search
const answer = tokensToHtml(data.nlg.text.answer)
const subject = data.visual.summary.subject

const meta = {
  title: tokensToText(data.nlg.text.answer),
  facebook: {
    imageUrl: imageForgeUrl({
      url: data.visual.summary.subject.imageUrl,
      bgColor: subject.colors.background,
      type: 'facebook',
    }),
  },
  twitter: {
    imageUrl: imageForgeUrl({
      url: data.visual.summary.subject.imageUrl,
      bgColor: subject.colors.background,
      type: 'twitter',
    }),
  },
}
---

<Layout
  {meta}
  colors={subject?.colors}
  {...Astro.props.meta ?? {}}
  analytics={{
    is_search: true,
    page_domain: preferredDomain as AnalyticsPageviewProperties['page_domain'],
    page_type: 'game',
  }}
>
  <Header {preferredDomain} share={{ url: Astro.url.href }} />
  <Hero
    content={answer}
    imageUrl={subject.imageUrl}
    imageAlt={subject.entities[0].display}
  />
  <Container>
    <slot />
    <Explore
      domain={preferredDomain}
      additionalQuestions={data.visual.additionalQuestions}
    />
  </Container>
</Layout>
