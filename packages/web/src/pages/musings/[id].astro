---
import Layout from '@layouts/main.astro'
import Header from '@components/header.astro'
import Hero from '@components/hero.astro'
import Visuals from '@components/visuals.astro'
import { getMusing } from '@statmuse/core/musings'
import { rgbToHex } from '@statmuse/core/color'
import { getHeroProps } from '@lib/gamera'
import type { Metadata } from '@lib/meta'

const { id } = Astro.params
const musing = await getMusing(id).executeTakeFirst()
if (!musing) return new Response(null, { status: 404, statusText: 'Not found' })

const query = musing.text ?? ''
const conversationToken = musing.input_conversation_token
const preferredDomain = musing.name

const foreground = musing.foreground_rgba
  ? rgbToHex(musing.foreground_rgba)
  : undefined
const background = musing.background_rgba
  ? rgbToHex(musing.background_rgba)
  : undefined

const heroProps = getHeroProps({ imageAlt: query, musing })

const capitalizeWord = ([first, ...rest]: string) =>
  first.toUpperCase() + rest.join('')

const meta: Metadata = {
  title: query.split(' ').map(capitalizeWord).join(' '),
  description: musing.text_plain ?? '',
}
---

<Layout {meta} colors={{ foreground, background }}>
  <Header
    {query}
    {conversationToken}
    {preferredDomain}
    share={{
      type: 'musing',
      query,
      domain: preferredDomain.toLowerCase(),
      shortCode: musing.short_code,
    }}
  />
  {heroProps ? <Hero {...heroProps} /> : null}
  <Visuals response={musing.answer} />
</Layout>
