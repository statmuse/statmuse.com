---
import TeamLayout from '@layouts/team.astro'
import Grid from '@components/grid.astro'

import {
 type  GameraDomain,
  getUrlForEntity,
  tokensToText,
} from '@statmuse/core/gamera'
import {
  getTeamSeasonBio,
  getTeamSeasonStats,
  getTeamSeasonPlayerStats,
} from '@lib/team'
import { getLeagueKeywords } from '@lib/meta'
import { Caching } from '@lib/caching'

const { league, team, year } = Astro.params
if (!team || !league || !year) {
  return new Response(null, { status: 404, statusText: 'Not found' })
}

const params = Astro.url.searchParams
const domain = league.toUpperCase() as GameraDomain
const bio = await getTeamSeasonBio({ domain, team, year })
const stats = await getTeamSeasonStats({ domain, team, year, params })
const playerStats = await getTeamSeasonPlayerStats({
  domain,
  team,
  year,
  params,
})
if (!bio || !stats || !playerStats) {
  return new Response(null, { status: 404, statusText: 'Not found' })
}

const [regularSeasonTeamStats, playoffTeamStats] = stats.grids
const [regularSeasonPlayerStats, playoffPlayerStats] = playerStats.grids

const title = `${year} ${bio.name} Team & Player Stats`
const description = bio.summaryNlg
  ? tokensToText(bio.summaryNlg)
  : `The ${year} ${bio.name} team and player stats for the ${domain} regular season and playoffs`
const keywords = `${getLeagueKeywords(domain)} ${year} ${
  bio.name
} team player stats statistics`
const canonical = {
  url: `${getUrlForEntity({
    type: 'teamSeason',
    domain,
    id: bio.teamId.toString(),
    display: bio.name,
  })}/stats/${year}`,
  rewrite: true,
}
const meta = { title, description, keywords, canonical }

Caching.swr(Astro)

---

<TeamLayout {bio} {meta}>
  <div>
    {
      regularSeasonTeamStats && (
        <Grid
          class="mb-5"
          data={regularSeasonTeamStats}
          parameters={stats.parameters}
        />
      )
    }
    {
      regularSeasonPlayerStats && (
        <Grid
          class="mb-5"
          data={regularSeasonPlayerStats}
          parameters={stats.parameters}
        />
      )
    }
    {
      playoffTeamStats && (
        <Grid
          class="mb-5"
          data={playoffTeamStats}
          parameters={stats.parameters}
        />
      )
    }
    {
      playoffPlayerStats && (
        <Grid
          class="mb-5"
          data={playoffPlayerStats}
          parameters={stats.parameters}
        />
      )
    }
  </div>
</TeamLayout>
