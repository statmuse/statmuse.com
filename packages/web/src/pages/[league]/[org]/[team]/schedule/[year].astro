---
import TeamLayout from '@layouts/team.astro'
import Grid from '@components/grid.svelte'
import {
  getUrlForEntity,
  type GameraGamesResponse,
  type InProgressGame,
  type ScheduledGame,
} from '@statmuse/core/gamera'
import {
  getGames,
  getTeamSeasonBio,
  getTeamSeasonGameResults,
  getTeamSeasonSchedule,
} from '@lib/gamera'
import { getLeagueKeywords } from '@lib/meta'
import { Caching } from '@lib/caching'
import { NOT_FOUND_404 } from '@lib/response'
import { leagueToDomain, type LeagueParam } from '@lib/params'
import { parseTeamId } from '@lib/parse'
import UpcomingGames from './_upcoming-games.astro'

const league = Astro.params.league as LeagueParam
const team = Astro.params.team
const year = Astro.params.year
const org = Astro.params.org
if (!team || !league || !year || !org) return NOT_FOUND_404
if (org !== 'team' && org !== 'club') return NOT_FOUND_404
const schedule = league === 'fc' ? 'fixtures' : 'schedule'
const scheduleDisplay = league === 'fc' ? 'Fixtures' : 'Schedule & Results'

const domain = leagueToDomain(league)
const bio = await getTeamSeasonBio({ context: Astro, domain, team, year })
const gameResults = await getTeamSeasonGameResults({
  context: Astro,
  domain,
  team,
  year,
})
const seasonSchedule = await getTeamSeasonSchedule({
  context: Astro,
  domain,
  team,
  year,
})

let gamesResponse:
  | GameraGamesResponse<ScheduledGame | InProgressGame>
  | undefined
if (league === 'mlb' || league === 'nfl') {
  gamesResponse = await getGames({
    context: Astro,
    domain: league,
    teamId: parseTeamId(team),
    seasonYear: year,
    gameState: ['inProgress', 'scheduled'],
  })
}

if (!bio || !gameResults) return NOT_FOUND_404

const title = `${bio.name} ${year} ${scheduleDisplay}`
const description = `The ${year} ${
  bio.name
} ${scheduleDisplay.toLowerCase()} for the ${domain} regular season and playoffs`
const keywords = `${getLeagueKeywords(domain)} ${year} ${
  bio.name
} ${org} ${schedule} results stats statistics`
const canonical = {
  url: `${getUrlForEntity({
    type: 'teamSeason',
    domain,
    id: bio.teamId.toString(),
    display: bio.name,
  })}/${schedule}/${year}`,
  rewrite: true,
}
const meta = { title, description, keywords, canonical }

Caching.swr(Astro)
---

<TeamLayout {bio} {meta} page="schedule">
  {
    gamesResponse && gamesResponse.games.length > 0 && (
      <UpcomingGames
        response={gamesResponse}
        teamId={Number.parseInt(parseTeamId(team))}
        domain={league}
      />
    )
  }
  {
    seasonSchedule?.grid &&
      seasonSchedule.grid.columns.length > 0 &&
      !gamesResponse && (
        <Grid
          title={seasonSchedule.grid.name}
          data={seasonSchedule.grid}
          class="md:w-[390px]"
          fullWidth={false}
          columnStyles={{
            DATE: 'text-left w-20',
            default: 'w-20',
          }}
        />
      )
  }
  {
    gameResults?.grids &&
      gameResults.grids.map((data) => (
        <Grid
          title={data.name}
          {data}
          class="md:w-[390px]"
          fullWidth={false}
          columnStyles={{
            DATE: 'text-left w-20',
            SCORE: 'text-left w-20',
            default: 'w-20',
          }}
        />
      ))
  }
</TeamLayout>
