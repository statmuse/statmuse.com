---
import Layout from '@layouts/main.astro'
import Header from '@components/header.astro'
import Hero from '@components/hero.astro'
import Visuals from '@components/visuals.astro'
import { handleResponse } from '@statmuse/core/gamera'
import { ask } from '@lib/gamera'

const { league: preferredDomain, question } = Astro.params
if (!question) return Astro.redirect('/questions')
const query = question.replaceAll('-', ' ')
const response = await ask({preferredDomain, query })
if (!response) return Astro.halt({ status: 404 })

const { subject, redirectUrl, conversationToken } = handleResponse(response)
if (redirectUrl) return Astro.redirect(redirectUrl)
---

<Layout colors={subject?.colors}>
  <Header {query} {preferredDomain} {conversationToken} />
  <Hero {response} {query} />
  <Visuals {response} />
</Layout>
