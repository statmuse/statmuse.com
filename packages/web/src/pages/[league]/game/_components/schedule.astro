---
import Image from '@components/image.astro'
import Panel from '@components/panel.astro'
import Timestamp from '@components/timestamp.svelte'
import type {
  MlbGameDataResponse,
  ScheduleGame,
  GameResult,
} from '@statmuse/core/gamera'
import { findIndex, takeWhile, takeRightWhile, find } from 'lodash-es'

type Game = GameResult | ScheduleGame

interface Props {
  teams: MlbGameDataResponse['teams']
  games?: Game[]
  currentGameId: number
}

const { teams, games: allGames, currentGameId } = Astro.props

if (!allGames) return undefined

const isGameResult = (game: Game): game is GameResult =>
  game.type === 'completed'

let games: Game[] = []

let gameIndex = findIndex(allGames, (g) =>
  isGameResult(g) ? g.id === currentGameId : g.gameId === currentGameId,
)
if (gameIndex !== -1) {
  const game = allGames[gameIndex]
  const awayTeamId = isGameResult(game) ? game.awayTeam.teamId : game.awayTeamId
  const homeTeamId = isGameResult(game) ? game.homeTeam.teamId : game.homeTeamId

  const sameTeams = (g: Game) => {
    if (isGameResult(g)) {
      return (
        (g.awayTeam.teamId === awayTeamId ||
          g.awayTeam.teamId === homeTeamId) &&
        (g.homeTeam.teamId === awayTeamId || g.homeTeam.teamId === homeTeamId)
      )
    } else {
      return (
        (g.awayTeamId === awayTeamId || g.awayTeamId === homeTeamId) &&
        (g.homeTeamId === awayTeamId || g.homeTeamId === homeTeamId)
      )
    }
  }

  const beforeGames = takeRightWhile(allGames.slice(0, gameIndex), sameTeams)
  const afterGames = takeWhile(allGames.slice(gameIndex), sameTeams)

  games = games.concat(beforeGames).concat(afterGames)
}
---

<Panel class="pb-0" title="Current Series">
  <div class="divide-y divide-gray-6 dark:divide-gray-4">
    {
      games.map((game, index) => {
        const awayTeamId = isGameResult(game)
          ? game.awayTeam.teamId
          : game.awayTeamId
        const homeTeamId = isGameResult(game)
          ? game.homeTeam.teamId
          : game.homeTeamId

        const awayTeam = find(teams, { teamId: awayTeamId })
        const homeTeam = find(teams, { teamId: homeTeamId })

        if (isGameResult(game)) {
          return (
            <div class="flex gap-3 py-2">
              <div class="flex-1">
                <div
                  class:list={{
                    'flex justify-between py-0.5': true,
                    'font-semibold': game.awayTeam.gameResult === 'win',
                  }}
                >
                  <div class="flex gap-1 items-center">
                    <Image
                      src={awayTeam?.logoImageUrl ?? ''}
                      alt={awayTeam?.name ?? ''}
                      width={60}
                      height={60}
                      class="w-5 h-5 object-contain"
                    />
                    <p>{awayTeam?.nickname}</p>
                  </div>
                  <p>{game.awayTeam.score}</p>
                </div>
                <div
                  class:list={{
                    'flex justify-between py-0.5': true,
                    'font-semibold': game.homeTeam.gameResult === 'win',
                  }}
                >
                  <div class="flex gap-1 items-center">
                    <Image
                      src={homeTeam?.logoImageUrl ?? ''}
                      alt={homeTeam?.name ?? ''}
                      width={60}
                      height={60}
                      class="w-5 h-5 object-contain"
                    />
                    <p>{homeTeam?.nickname}</p>
                  </div>
                  <p>{game.homeTeam.score}</p>
                </div>
              </div>
              <div class="w-16 flex items-center justify-end text-right text-sm text-gray-5">
                <div>
                  <p>Game {index + 1}</p>
                  <p>Final</p>
                </div>
              </div>
            </div>
          )
        } else {
          return (
            <div class="flex gap-3 py-2">
              <div class="flex-1">
                <div class="flex gap-1 py-0.5">
                  <Image
                    src={awayTeam?.logoImageUrl ?? ''}
                    alt={awayTeam?.name ?? ''}
                    width={60}
                    height={60}
                    class="w-5 h-5 object-contain"
                  />
                  <p>{awayTeam?.nickname}</p>
                </div>
                <div class="flex gap-1 py-0.5">
                  <Image
                    src={homeTeam?.logoImageUrl ?? ''}
                    alt={homeTeam?.name ?? ''}
                    width={60}
                    height={60}
                    class="w-5 h-5 object-contain"
                  />
                  <p>{homeTeam?.nickname}</p>
                </div>
              </div>
              <div class="flex items-center justify-end text-right text-sm">
                <div>
                  <p>Game {index + 1}</p>
                  <p>
                    <Timestamp
                      client:only="svelte"
                      timestamp={game.gameTimestamp}
                    />
                  </p>
                </div>
              </div>
              <div class="w-16 flex items-center justify-end text-right text-sm text-gray-5">
                <p>
                  {homeTeam?.abbreviation}{' '}
                  {game.odds?.sportsbooks[0].homeTeam.spreadOdds.display}
                </p>
              </div>
            </div>
          )
        }
      })
    }
  </div>
</Panel>
