---
import { getGames, getPlayByPlay } from '@lib/gamera'
import Layout from './layout.astro'
import { type MlbGameDataResponse } from '@statmuse/core/gamera'
import { find } from 'lodash-es'
import GameInfo from './game-info.astro'
import Matchup from './matchup.svelte'
import PitchByPitch from './pitch-by-pitch.svelte'
import Linescore from './linescore.svelte'
import PlayByPlay from './play-by-play.svelte'
import LivegameHero from './livegame-hero.astro'
import BattingStats from './batting-stats.svelte'
import PitchingStats from './pitching-stats.svelte'
import GameState from './game-state.svelte'
import Realtime from '@components/realtime.svelte'
import {
  gameState,
  innings,
  gameScore,
  lineScore,
  players,
  lineup,
  stats,
} from './stores'

interface Props {
  gameData: MlbGameDataResponse
  gameId: string
}

const { gameData, gameId } = Astro.props

const {
  seasonYearDisplay: seasonYear,
  networkName,
  awayTeam: awayTeamModel,
  homeTeam: homeTeamModel,
  teams,
  venue,
  weather,
  officials,
} = gameData

const [homeTeamGames, awayTeamGames, playByPlay] = await Promise.all([
  getGames({
    context: Astro,
    domain: 'mlb',
    teamId: homeTeamModel.teamId,
    seasonYear,
    gameState: 'completed',
  }),
  getGames({
    context: Astro,
    domain: 'mlb',
    teamId: awayTeamModel.teamId,
    seasonYear,
    gameState: 'completed',
  }),
  getPlayByPlay({ context: Astro, gameId }),
])

const awayTeam = find(teams, { teamId: awayTeamModel.teamId })
const homeTeam = find(teams, { teamId: homeTeamModel.teamId })

gameState.set({ gameData, playByPlay })
innings.set(playByPlay?.innings ?? [])
gameScore.set({
  away: gameData.awayTeam.score,
  home: gameData.homeTeam.score,
})
lineScore.set({
  away: gameData.awayTeam.lineScore,
  home: gameData.homeTeam.lineScore,
})
stats.set({
  away: gameData.awayTeam.stats,
  home: gameData.homeTeam.stats,
})
lineup.set({
  away: gameData.awayTeam.players,
  home: gameData.homeTeam.players,
})
players.set(
  gameData.players?.reduce((acc, p) => ({ ...acc, [p.id]: p }), {}) ?? {},
)
---

<Layout {awayTeam} {homeTeam}>
  <LivegameHero
    slot="hero"
    network={networkName}
    {awayTeam}
    awayTeamGames={awayTeamGames?.games.filter((g) => g.type === 'completed')}
    {homeTeam}
    homeTeamGames={homeTeamGames?.games.filter((g) => g.type === 'completed')}
  >
    <nav
      class:list={{
        'hidden md:flex gap-3 justify-center': true,
        'overflow-x-scroll no-scrollbar': true,
        'pt-3': true,
      }}
    >
      <div class="group/nav flex flex-col gap-1.5 overflow-clip">
        <label
          class:list={{
            'cursor-pointer whitespace-nowrap': true,
          }}
          for="game"
          set:html="Game"
        />
        <div
          class:list={{
            'w-full h-5 -mb-2.5 bg-current rounded-2xl': true,
            'hidden group-has-[#game:checked]:block group-has-[#plays:checked]:block group-hover/nav:block': true,
          }}
        >
        </div>
      </div>
      <div class="group/nav flex flex-col gap-1.5 overflow-clip">
        <label
          class:list={{
            'cursor-pointer whitespace-nowrap': true,
          }}
          for="away"
          set:html={awayTeam?.nickname}
        />
        <div
          class:list={{
            'w-full h-5 -mb-2.5 bg-current rounded-2xl': true,
            'hidden group-has-[#away:checked]:block group-hover/nav:block': true,
          }}
        >
        </div>
      </div>
      <div class="group/nav flex flex-col gap-1.5 overflow-clip">
        <label
          class:list={{
            'cursor-pointer whitespace-nowrap': true,
          }}
          for="home"
          set:html={homeTeam?.nickname}
        />
        <div
          class:list={{
            'w-full h-5 -mb-2.5 bg-current rounded-2xl': true,
            'hidden group-has-[#home:checked]:block group-hover/nav:block': true,
          }}
        >
        </div>
      </div>
    </nav>
  </LivegameHero>

  <div slot="game" class="flex gap-3">
    <div class="flex-1 flex flex-col gap-3">
      <Matchup client:load {awayTeam} {homeTeam} />
      <PitchByPitch client:load />
      <Linescore client:load {awayTeam} {homeTeam} />
      <div class="md:hidden flex flex-col gap-3">
        <PlayByPlay client:load {awayTeam} {homeTeam} scoring />
      </div>
      <GameInfo {venue} {weather} {officials} />
    </div>
    <div class="group/plays flex-1 hidden md:block">
      <div
        class="bg-gray-8 dark:bg-gray-3 text-inherit border border-gray-6 dark:border-gray-3 flex text-center mb-3 rounded-full relative overflow-clip"
      >
        <div
          class="absolute h-full w-1/2 bg-teal rounded-full left-0 group-has-[#all:checked]/plays:translate-x-0 group-has-[#scoring:checked]/plays:translate-x-full transition-transform ease-out"
        >
        </div>
        <label
          for="all"
          class:list={{
            'flex-1 py-1 hover:cursor-pointer relative': true,
            'group-has-[#all:checked]/plays:text-gray-8': true,
          }}
        >
          All Plays
        </label>
        <label
          for="scoring"
          class:list={{
            'flex-1 py-1 hover:cursor-pointer relative': true,
            'group-has-[#scoring:checked]/plays:text-gray-8': true,
          }}
        >
          Scoring Plays
        </label>
      </div>
      <div class="hidden has-[#all:checked]:flex flex-col gap-3">
        <input
          class="absolute opacity-0"
          type="radio"
          name="plays"
          id="all"
          checked
        />
        <PlayByPlay client:load {awayTeam} {homeTeam} />
      </div>
      <div class="hidden has-[#scoring:checked]:flex flex-col gap-3">
        <input
          class="absolute opacity-0"
          type="radio"
          name="plays"
          id="scoring"
        />
        <PlayByPlay client:load {awayTeam} {homeTeam} scoring />
      </div>
    </div>
  </div>

  <Fragment slot="away">
    <Linescore client:load {awayTeam} {homeTeam} displayMatchup />
    <BattingStats client:load teamKey="away" />
    <PitchingStats client:load teamKey="away" />
  </Fragment>

  <Fragment slot="home">
    <Linescore client:load {awayTeam} {homeTeam} displayMatchup />
    <BattingStats client:load teamKey="home" />
    <PitchingStats client:load teamKey="home" />
  </Fragment>

  <PlayByPlay client:load slot="plays" {awayTeam} {homeTeam} />

  <GameState client:only="svelte" {gameData} {playByPlay} />
  <Realtime client:only="svelte" {gameId} />
</Layout>
