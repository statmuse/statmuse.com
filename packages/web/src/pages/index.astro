---
import HomeLayout from '@layouts/home.astro'
import Image from '@components/image.astro'
import { rgbToHex } from '@statmuse/core/color'
import { listLatestMusings } from '@statmuse/core/musing'
import { relativeTimeFromDates } from '@statmuse/core/time'
import { Caching } from '@lib/caching'

const musings = await listLatestMusings.execute()

Caching.swr(Astro)
---

<HomeLayout>
  <div class="gap-3 space-y-3 columns-xs">
    {
      musings.map(async (musing, i) => (
        <div class="break-inside-avoid-column">
          <a
            href={`/musings/${musing.friendly_id}`}
            class:list={{
              // 'md:max-w-[33%]': true,
              'no-underline hover:no-underline': true,
              'grid grid-cols-2 py-2 px-3 rounded-2xl font-light shrink-0': true,
              'cursor-pointer hover:-brightness-[110%] active:brightness-[80%]': true,
            }}
            style={`background-color: ${rgbToHex(
              musing.background_rgba,
            )};color: ${rgbToHex(musing.foreground_rgba)};`}
          >
            <div
              class="leading-snug whitespace-pre-wrap text-pretty"
              set:text={musing.text_plain?.replaceAll(/^-   /gm, '')}
            />
            <div class="flex flex-col justify-between -mb-2">
              <div class="text-right">
                {relativeTimeFromDates(musing.publish_at)}
              </div>
              <Image
                data-cy-illustration
                class="h-36 max-w-full object-contain object-bottom"
                style="visibility: unset;"
                alt={musing.text_plain}
                src={musing.image_url!}
                width={400}
                height={400}
                loading={i < 4 ? 'eager' : 'lazy'}
              />
            </div>
          </a>
        </div>
      ))
    }
  </div>
</HomeLayout>
