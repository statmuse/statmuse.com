---
import ElephantPlus from '@components/icons/elephant-plus.astro'
---

<div class="relative">
  <div style={{ maxHeight: '892px', overflow: 'hidden' }} data-accordion>
    <slot />
  </div>
  <div
    class="hidden absolute bottom-4 left-1/2 -translate-x-1/2"
    data-subscribe-cta
  >
    <a
      href="/auth/signup"
      class="flex gap-2 items-center w-fit py-3 px-4 bg-primary text-white text-lg rounded-md"
    >
      <span class="shrink-0 mt-[1px]">Unlock 2x data</span>
      <ElephantPlus color="#fff" class="w-10" />
    </a>
  </div>
  <div class="hidden" data-expand-btn>
    <a href="#">See all rows</a>
  </div>
</div>
<script>
  import { session } from '@lib/session-store'
  const freeRowLimit = 25

  document.addEventListener('astro:page-load', () => {
    session.subscribe((s) => {
      if (s) {
        if (s.type === 'user' && s.properties.subscriptionStatus === 'active') {
          document.querySelectorAll('table').forEach((table) => {
            const numRows = table.querySelectorAll('tbody tr').length
            if (numRows > freeRowLimit + 3) {
              const expandBtn = table
                .closest('[data-accordion]')
                ?.parentElement?.querySelector<HTMLElement>('[data-expand-btn]')
              if (expandBtn) {
                expandBtn.classList.remove('hidden')
                expandBtn.addEventListener('click', (e) => {
                  e.preventDefault()
                  const accordion = table.closest<HTMLElement>(
                    '[data-accordion]',
                  ) as HTMLElement
                  accordion.style.maxHeight = ''
                  expandBtn.classList.add('hidden')
                })
              }
            }
          })
        } else {
          document.querySelectorAll('table').forEach((table) => {
            const numRows = table.querySelectorAll('tbody tr').length
            if (numRows > freeRowLimit) {
              const subscribeCta = table
                .closest('[data-accordion]')
                ?.parentElement?.querySelector<HTMLElement>(
                  '[data-subscribe-cta]',
                )
              if (subscribeCta) {
                subscribeCta.classList.remove('hidden')
              }
            }
          })
        }
      }
    })
  })
</script>
